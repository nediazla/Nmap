### Descubrimiento de host
Uno de los primeros pasos en cualquier misión de reconocimiento de red es reducir un conjunto (a veces enorme) de rangos de IP a una lista de hosts activos o interesantes. Escanear cada puerto de cada dirección IP es lento y generalmente innecesario. Por supuesto, lo que hace que un host sea interesante depende en gran medida de los propósitos del análisis. Es posible que los administradores de red solo estén interesados ​​en los hosts que ejecutan un determinado servicio, mientras que los auditores de seguridad pueden preocuparse por cada dispositivo con una dirección IP. Un administrador puede sentirse cómodo utilizando sólo un ping ICMP para localizar hosts en su red interna, mientras que un probador de penetración externo puede utilizar un conjunto diverso de docenas de sondas en un intento de evadir las restricciones del firewall.

Debido a que las necesidades de descubrimiento de hosts son tan diversas, Nmap ofrece una amplia variedad de opciones para personalizar las técnicas utilizadas. El descubrimiento de host a veces se denomina escaneo de ping, pero va mucho más allá de los simples paquetes de solicitud de eco ICMP asociados con la omnipresente herramienta de ping. Los usuarios pueden omitir el paso de descubrimiento por completo con un escaneo de lista (-sL) o deshabilitando el descubrimiento de host (-Pn), o conectar la red con combinaciones arbitrarias de sondas multipuerto TCP SYN/ACK, UDP, SCTP INIT e ICMP. El objetivo de estas sondas es solicitar respuestas que demuestren que una dirección IP está realmente activa (está siendo utilizada por un host o dispositivo de red). En muchas redes, sólo un pequeño porcentaje de direcciones IP están activas en un momento dado. Esto es particularmente común con espacios de direcciones privados como 10.0.0.0/8. Esa red tiene 16 millones de IP, pero la he visto utilizada por empresas con menos de mil máquinas. El descubrimiento de hosts puede encontrar esas máquinas en un mar de direcciones IP escasamente asignadas.

Si no se proporcionan opciones de descubrimiento de host, Nmap envía una solicitud de eco ICMP, un paquete TCP SYN al puerto 443, un paquete TCP ACK al puerto 80 y una solicitud de marca de tiempo ICMP. (Para IPv6, la solicitud de marca de tiempo ICMP se omite porque no forma parte de ICMPv6). Estos valores predeterminados son equivalentes a las opciones -PE -PS443 -PA80 -PP. Las excepciones a esto son los análisis ARP (para IPv4) y Neighbor Discovery (para IPv6), que se utilizan para cualquier objetivo en una red Ethernet local. Para usuarios de shell Unix sin privilegios, las sondas predeterminadas son un paquete SYN a los puertos 80 y 443 mediante la llamada al sistema de conexión. Este descubrimiento de host suele ser suficiente al escanear redes locales, pero se recomienda un conjunto más completo de sondas de descubrimiento para la auditoría de seguridad.

Las opciones `-P*` (que seleccionan tipos de ping) se pueden combinar. Puede aumentar sus probabilidades de penetrar firewalls estrictos enviando muchos tipos de sondas utilizando diferentes puertos/indicadores TCP y códigos ICMP. También tenga en cuenta que ARP/Neighbor Discovery se realiza de forma predeterminada contra objetivos en una red Ethernet local incluso si especifica otras opciones -P*, porque casi siempre es más rápido y efectivo.

De forma predeterminada, Nmap descubre hosts y luego realiza una exploración de puertos en cada host que determina que está en línea. Esto es cierto incluso si especifica tipos de descubrimiento de host no predeterminados, como sondas UDP (-PU). Lea acerca de la opción -sn para aprender cómo realizar solo el descubrimiento de host, o use -Pn para omitir el descubrimiento de host y escanear puertos en todas las direcciones de destino. Las siguientes opciones controlan el descubrimiento de host:

`-sL` (escaneo de lista)
La exploración de lista es una forma degenerada de descubrimiento de hosts que simplemente enumera cada host de las redes especificadas, sin enviar ningún paquete a los hosts de destino. De forma predeterminada, Nmap todavía realiza resolución DNS inversa en los hosts para conocer sus nombres. A menudo sorprende la cantidad de información útil que proporcionan los nombres de host simples. Por ejemplo, fw.chi es el nombre del firewall de una empresa en Chicago. Nmap también informa el número total de direcciones IP al final. El escaneo de la lista es una buena verificación de cordura para garantizar que tiene las direcciones IP adecuadas para sus objetivos. Si los hosts tienen nombres de dominio que usted no reconoce, vale la pena investigar más a fondo para evitar escanear la red de la empresa equivocada.

Dado que la idea es simplemente imprimir una lista de hosts de destino, las opciones para funcionalidades de nivel superior, como escaneo de puertos, detección de sistema operativo o descubrimiento de hosts, no se pueden combinar con esto. Si desea deshabilitar el descubrimiento de host mientras sigue realizando dicha funcionalidad de nivel superior, lea sobre la opción -Pn (omitir descubrimiento de host).

`-sn` (Sin escaneo de puertos)
Esta opción le dice a Nmap que no realice una exploración de puertos después del descubrimiento de host y que solo imprima los hosts disponibles que respondieron a las sondas de descubrimiento de host. Esto a menudo se conoce como “exploración de ping”, pero también puede solicitar que se ejecuten los scripts de host traceroute y NSE. Por defecto, este es un paso más intrusivo que el escaneo de la lista y, a menudo, puede usarse para los mismos propósitos. Permite un reconocimiento ligero de una red objetivo sin llamar mucho la atención. Saber cuántos hosts están activos es más valioso para los atacantes que la lista proporcionada por el escaneo de cada IP y nombre de host.

Los administradores de sistemas también suelen encontrar valiosa esta opción. Puede usarse fácilmente para contar las máquinas disponibles en una red o monitorear la disponibilidad del servidor. Esto a menudo se denomina barrido de ping y es más confiable que hacer ping a la dirección de transmisión porque muchos hosts no responden a las consultas de transmisión.

El descubrimiento de host predeterminado realizado con -sn consta de una solicitud de eco ICMP, TCP SYN al puerto 443, TCP ACK al puerto 80 y una solicitud de marca de tiempo ICMP de forma predeterminada. Cuando lo ejecuta un usuario sin privilegios, solo se envían paquetes SYN (mediante una llamada de conexión) a los puertos 80 y 443 del destino. Cuando un usuario privilegiado intenta escanear objetivos en una red Ethernet local, se utilizan solicitudes ARP a menos que se haya especificado --send-ip. La opción -sn se puede combinar con cualquiera de los tipos de sonda de descubrimiento (las opciones -P*) para mayor flexibilidad. Si se utiliza cualquiera de esas opciones de tipo de sonda y número de puerto, se anulan las sondas predeterminadas. Cuando existen firewalls estrictos entre el host de origen que ejecuta Nmap y la red de destino, se recomienda utilizar esas técnicas avanzadas. De lo contrario, los hosts podrían pasar desapercibidos cuando el firewall descarte las sondas o sus respuestas.

En versiones anteriores de Nmap, -sn se conocía como -sP.

`-Pn` (Sin ping)
Esta opción omite por completo la etapa de descubrimiento del host. Normalmente, Nmap utiliza esta etapa para determinar las máquinas activas para un escaneo más intenso y medir la velocidad de la red. De forma predeterminada, Nmap solo realiza pruebas exhaustivas, como escaneos de puertos, detección de versiones o detección de sistemas operativos, en hosts que se encuentran activos. Deshabilitar el descubrimiento de host con -Pn hace que Nmap intente las funciones de escaneo solicitadas contra cada dirección IP de destino especificada. Entonces, si se especifica una red de tamaño /16 en la línea de comando, se escanean las 65,536 direcciones IP. Se omite el descubrimiento adecuado del host al igual que con la exploración de la lista, pero en lugar de detener e imprimir la lista de destino, Nmap continúa realizando las funciones solicitadas como si cada IP de destino estuviera activa. Se utilizan parámetros de sincronización predeterminados, lo que puede resultar en escaneos más lentos. Para omitir el descubrimiento de host y la exploración de puertos, y al mismo tiempo permitir que NSE se ejecute, use las dos opciones -Pn -sn juntas.

Para máquinas en una red Ethernet local, el escaneo ARP aún se realizará (a menos que se especifique --disable-arp-ping o --send-ip) porque Nmap necesita direcciones MAC para escanear más los hosts de destino. En versiones anteriores de Nmap, -Pn era -P0 y -PN.

`-PS <lista de puertos>` (Ping TCP SYN)
Esta opción envía un paquete TCP vacío con el indicador SYN configurado. El puerto de destino predeterminado es 80 (configurable en tiempo de compilación cambiando DEFAULT_TCP_PROBE_PORT_SPEC en nmap.h). Se pueden especificar puertos alternativos como parámetro. La sintaxis es la misma que para -p excepto que los especificadores de tipo de puerto como T: no están permitidos. Algunos ejemplos son -PS22 y -PS22-25,80,113,1050,35000. Tenga en cuenta que no puede haber espacio entre -PS y la lista de puertos. Si se especifican varias sondas, se enviarán en paralelo.

El indicador SYN sugiere al sistema remoto que está intentando establecer una conexión. Normalmente, el puerto de destino se cerrará y se devolverá un paquete RST (reinicio). Si el puerto está abierto, el objetivo dará el segundo paso de un protocolo de enlace de tres vías TCP respondiendo con un paquete TCP SYN/ACK. La máquina que ejecuta Nmap luego interrumpe la conexión naciente respondiendo con un RST en lugar de enviar un paquete ACK que completaría el protocolo de enlace de tres vías y establecería una conexión completa. El paquete RST es enviado por el núcleo de la máquina que ejecuta Nmap en respuesta al SYN/ACK inesperado, no por Nmap en sí.

A Nmap no le importa si el puerto está abierto o cerrado. La respuesta RST o SYN/ACK discutida anteriormente le dice a Nmap que el host está disponible y responde.

En sistemas Unix, generalmente sólo el usuario raíz privilegiado puede enviar y recibir paquetes TCP sin procesar. Para los usuarios sin privilegios, se emplea automáticamente una solución mediante la cual la llamada al sistema de conexión se inicia en cada puerto de destino. Esto tiene el efecto de enviar un paquete SYN al host de destino, en un intento de establecer una conexión. Si la conexión regresa con un éxito rápido o una falla ECONNREFUSED, la pila TCP subyacente debe haber recibido un SYN/ACK o RST y el host está marcado como disponible. Si el intento de conexión se deja suspendido hasta que se alcanza el tiempo de espera, el host se marca como inactivo.

`-PA <lista de puertos>` (Ping de confirmación de TCP)
El ping TCP ACK es bastante similar al ping SYN que acabamos de comentar. La diferencia, como probablemente puedas adivinar, es que el indicador TCP ACK está configurado en lugar del indicador SYN. Un paquete ACK de este tipo pretende reconocer datos a través de una conexión TCP establecida, pero dicha conexión no existe. Por lo tanto, los hosts remotos siempre deben responder con un paquete RST, revelando su existencia en el proceso.

La opción -PA utiliza el mismo puerto predeterminado que la sonda SYN (80) y también puede tomar una lista de puertos de destino en el mismo formato. Si un usuario sin privilegios intenta esto, se utiliza la solución alternativa de conexión comentada anteriormente. Esta solución alternativa es imperfecta porque Connect en realidad envía un paquete SYN en lugar de un ACK.

La razón para ofrecer sondas de ping SYN y ACK es maximizar las posibilidades de eludir los firewalls. Muchos administradores configuran enrutadores y otros cortafuegos simples para bloquear los paquetes SYN entrantes, excepto aquellos destinados a servicios públicos como el sitio web de la empresa o el servidor de correo. Esto evita otras conexiones entrantes a la organización, al tiempo que permite a los usuarios realizar conexiones salientes a Internet sin obstáculos. Este enfoque sin estado consume pocos recursos en el firewall/enrutador y es ampliamente compatible con filtros de hardware y software. El software de firewall Netfilter/iptables de Linux ofrece la conveniente opción --syn para implementar este enfoque sin estado. Cuando existen reglas de firewall sin estado como ésta, es probable que las sondas de ping SYN (-PS) se bloqueen cuando se envían a puertos de destino cerrados. En tales casos, la sonda ACK brilla al atravesar estas reglas.

Otro tipo común de firewall utiliza reglas con estado que descartan paquetes inesperados. Inicialmente, esta característica se encontraba principalmente en firewalls de alta gama, aunque se ha vuelto mucho más común con el paso de los años. El sistema Linux Netfilter/iptables admite esto a través de la opción --state, que clasifica los paquetes según el estado de la conexión. Es más probable que una sonda SYN funcione contra dicho sistema, ya que los paquetes ACK inesperados generalmente se reconocen como falsos y se descartan. Una solución a este dilema es enviar sondas SYN y ACK especificando -PS y -PA.

`-PU <lista de puertos>` (Ping UDP)
Otra opción de descubrimiento de host es el ping UDP, que envía un paquete UDP a los puertos indicados. Para la mayoría de los puertos, el paquete estará vacío, aunque algunos utilizan una carga útil específica del protocolo que es más probable que provoque una respuesta. Las cargas útiles son las mismas sondas utilizadas en la detección de servicios y versiones y están definidas en el archivo nmap-service-probes. El contenido del paquete también puede verse afectado con las opciones --data, --data-string y --data-length.

La lista de puertos toma el mismo formato que las opciones -PS y -PA analizadas anteriormente. Si no se especifica ningún puerto, el valor predeterminado es 40125. Este valor predeterminado se puede configurar en tiempo de compilación cambiando DEFAULT_UDP_PROBE_PORT_SPEC en nmap.h. De forma predeterminada se utiliza un puerto muy poco común porque el envío a puertos abiertos a menudo no es deseable para este tipo de análisis en particular.

Al llegar a un puerto cerrado en la máquina de destino, la sonda UDP debería generar a cambio un paquete de puerto ICMP inalcanzable. Esto le indica a Nmap que la máquina está activa y disponible. Muchos otros tipos de errores ICMP, como host/red inalcanzable o TTL excedido, son indicativos de un host inactivo o inalcanzable. La falta de respuesta también se interpreta de esta manera. Si se alcanza un puerto abierto, la mayoría de los servicios simplemente ignoran el paquete vacío y no devuelven ninguna respuesta. Esta es la razón por la que el puerto de sonda predeterminado es 40125, que es muy poco probable que esté en uso. Algunos servicios, como el protocolo Generador de caracteres (chargen), responderán a un paquete UDP vacío y, por tanto, informarán a Nmap que la máquina está disponible.

La principal ventaja de este tipo de análisis es que evita los cortafuegos y los filtros que solo filtran TCP. Por ejemplo, una vez tuve un enrutador de banda ancha inalámbrico Linksys BEFW11S4. La interfaz externa de este dispositivo filtraba todos los puertos TCP de forma predeterminada, pero las sondas UDP aún obtenían mensajes de puerto inalcanzable y, por lo tanto, revelaban el dispositivo.

`-PY <lista de puertos>` (ping SCTP INIT)
Esta opción envía un paquete SCTP que contiene un fragmento INIT mínimo. El puerto de destino predeterminado es 80 (configurable en tiempo de compilación cambiando DEFAULT_SCTP_PROBE_PORT_SPEC en nmap.h). Se pueden especificar puertos alternativos como parámetro. La sintaxis es la misma que para -p excepto que los especificadores de tipo de puerto como S: no están permitidos. Algunos ejemplos son -PY22 y -PY22,80,179,5060. Tenga en cuenta que no puede haber espacio entre -PY y la lista de puertos. Si se especifican varias sondas, se enviarán en paralelo.

El fragmento INIT sugiere al sistema remoto que está intentando establecer una asociación. Normalmente, el puerto de destino se cerrará y se devolverá un fragmento ABORT. Si el puerto está abierto, el objetivo dará el segundo paso de un protocolo de enlace SCTP de cuatro vías respondiendo con un fragmento INIT-ACK. Si la máquina que ejecuta Nmap tiene una pila SCTP funcional, entonces derriba la asociación naciente respondiendo con un fragmento ABORT en lugar de enviar un fragmento COOKIE-ECHO, que sería el siguiente paso en el protocolo de enlace de cuatro vías. El paquete ABORT es enviado por el núcleo de la máquina que ejecuta Nmap en respuesta al INIT-ACK inesperado, no por Nmap en sí.

A Nmap no le importa si el puerto está abierto o cerrado. La respuesta ABORT o INIT-ACK discutida anteriormente le dice a Nmap que el host está disponible y responde.

En cajas Unix, sólo el usuario raíz privilegiado generalmente puede enviar y recibir paquetes SCTP sin formato. Actualmente, los usuarios sin privilegios no pueden utilizar SCTP INIT Pings.

`-PE`;` -PP`; `-PM` (Tipos de ping ICMP)
Además de los inusuales tipos de descubrimiento de host TCP, UDP y SCTP discutidos anteriormente, Nmap puede enviar los paquetes estándar enviados por el omnipresente programa ping. Nmap envía un paquete ICMP tipo 8 (solicitud de eco) a las direcciones IP de destino, esperando un tipo 0 (respuesta de eco) a cambio de los hosts disponibles. Desafortunadamente para los exploradores de redes, muchos hosts y firewalls ahora bloquean estos paquetes, en lugar de responder como exige el RFC 1122. Por esta razón, los escaneos solo ICMP rara vez son lo suficientemente confiables contra objetivos desconocidos a través de Internet. Pero para los administradores de sistemas que monitorean una red interna, pueden ser un enfoque práctico y eficiente. Utilice la opción -PE para habilitar este comportamiento de solicitud de eco.

Si bien la solicitud de eco es la consulta de ping ICMP estándar, Nmap no se detiene ahí. Los estándares ICMP (RFC 792 y RFC 950) también especifican los paquetes de solicitud de marca de tiempo, solicitud de información y solicitud de máscara de dirección como códigos 13, 15 y 17, respectivamente. Si bien el propósito aparente de estas consultas es obtener información como máscaras de direcciones y horas actuales, se pueden utilizar fácilmente para el descubrimiento de hosts. Un sistema que responde está activo y disponible. Actualmente, Nmap no implementa paquetes de solicitud de información, ya que no cuentan con un soporte generalizado. RFC 1122 insiste en que “un host NO DEBE implementar estos mensajes”. Las consultas de marca de tiempo y máscara de dirección se pueden enviar con las opciones -PP y -PM, respectivamente. Una respuesta de marca de tiempo (código ICMP 14) o una respuesta de máscara de dirección (código 18) revela que el host está disponible. Estas dos consultas pueden ser valiosas cuando los administradores bloquean específicamente los paquetes de solicitud de eco y olvidan que se pueden usar otras consultas ICMP para el mismo propósito.

`-PO <lista de protocolos>` (Ping de protocolo IP)
Una de las opciones más nuevas de descubrimiento de host es el ping del protocolo IP, que envía paquetes IP con el número de protocolo especificado establecido en su encabezado IP. La lista de protocolos toma el mismo formato que las listas de puertos en las opciones de descubrimiento de hosts TCP, UDP y SCTP analizadas anteriormente. Si no se especifica ningún protocolo, el valor predeterminado es enviar varios paquetes IP para ICMP (protocolo 1), IGMP (protocolo 2) e IP-in-IP (protocolo 4). Los protocolos predeterminados se pueden configurar en tiempo de compilación cambiando DEFAULT_PROTO_PROBE_PORT_SPEC en nmap.h. Tenga en cuenta que para ICMP, IGMP, TCP (protocolo 6), UDP (protocolo 17) y SCTP (protocolo 132), los paquetes se envían con los encabezados de protocolo adecuados, mientras que otros protocolos se envían sin datos adicionales más allá del encabezado IP (a menos que se especifica cualquiera de las opciones --data, --data-string o --data-length).

Este método de descubrimiento de host busca respuestas utilizando el mismo protocolo que una sonda o mensajes inalcanzables del protocolo ICMP que significan que el protocolo determinado no es compatible con el host de destino. Cualquier tipo de respuesta significa que el host objetivo está vivo.

`--disable-arp-ping` (Sin ARP ni ND Ping)
Nmap normalmente realiza descubrimientos de vecinos (ND) ARP o IPv6 de hosts Ethernet conectados localmente, incluso si se utilizan otras opciones de descubrimiento de hosts como -Pn o -PE. Para deshabilitar este comportamiento implícito, use la opción --disable-arp-ping.

El comportamiento predeterminado suele ser más rápido, pero esta opción es útil en redes que utilizan proxy ARP, en las que un enrutador responde especulativamente a todas las solicitudes ARP, haciendo que cada objetivo parezca estar activo según el escaneo ARP.

`--discovery-ignore-rst`
En algunos casos, los firewalls pueden falsificar respuestas de restablecimiento de TCP (RST) en respuesta a sondeos en direcciones desocupadas o no permitidas. Dado que Nmap normalmente considera que las respuestas RST son una prueba de que el objetivo está activo, esto puede llevar a una pérdida de tiempo escaneando objetivos que no están allí. El uso de --discovery-ignore-rst evitará que Nmap considere estas respuestas durante el descubrimiento del host. Es posible que deba seleccionar opciones adicionales de descubrimiento de host para asegurarse de no perder objetivos en este caso.

`--traceroute` (ruta de seguimiento al host)
Las rutas de seguimiento se realizan después del escaneo utilizando información de los resultados del escaneo para determinar el puerto y el protocolo con mayor probabilidad de llegar al objetivo. Funciona con todos los tipos de escaneo excepto escaneos conectados (-sT) y escaneos inactivos (-sI). Todos los seguimientos utilizan el modelo de sincronización dinámica de Nmap y se realizan en paralelo.

Traceroute funciona enviando paquetes con un TTL (tiempo de vida) bajo en un intento de obtener mensajes ICMP de tiempo excedido de saltos intermedios entre el escáner y el host de destino. Las implementaciones de traceroute estándar comienzan con un TTL de 1 y lo incrementan hasta llegar al host de destino. El traceroute de Nmap comienza con un TTL alto y luego lo disminuye hasta llegar a cero. Hacerlo al revés permite a Nmap emplear algoritmos de almacenamiento en caché inteligentes para acelerar los rastreos en múltiples hosts. En promedio, Nmap envía entre 5 y 10 paquetes menos por host, según las condiciones de la red. Si se está escaneando una sola subred (es decir, 192.168.0.0/24), es posible que Nmap solo tenga que enviar dos paquetes a la mayoría de los hosts.